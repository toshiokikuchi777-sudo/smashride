-- StarterPlayer/StarterPlayerScripts/Controllers/HammerShopController.lua
-- ãƒãƒ³ãƒãƒ¼ã‚·ãƒ§ãƒƒãƒ—ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´å‡¦ç†

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local pgui = player:WaitForChild("PlayerGui")
local Net = require(ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Net"))
local HammerShopConfig = require(ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Config"):WaitForChild("HammerShopConfig"))
local GameConfig = require(ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Config"):WaitForChild("GameConfig"))

local HammerShopController = {}

-- UIå‚ç…§
local shopFrame
local shopButton
local hammerCards = {}
local selectedHammerId = nil -- ç¾åœ¨é¸æŠä¸­ã®ãƒãƒ³ãƒãƒ¼ID

-- è©³ç´°ãƒ‘ãƒãƒ«ã®ãƒ‘ãƒ¼ãƒ„å‚ç…§
local detailPanel
local detailIcon
local detailName
local detailDamage
local detailAbility
local detailLimit
local detailActionButton
local detailPriceIcon
local detailPriceLabel

-- RemoteFunctions
local PurchaseHammerFunc
local EquipHammerFunc
local GetHammersFunc

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿
local playerData = {
	owned = {},
	equipped = "BASIC",
	scrap = 0
}

-- ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼ˆé€£æ‰“/é€£ç¶šç™ºç«é˜²æ­¢ï¼‰
local opening = false

-- é–¢æ•°å‰æ–¹å®£è¨€
local updateUI

----------------------------------------------------------------
-- ãƒ˜ãƒ«ãƒ‘ãƒ¼: çŠ¶æ…‹ãƒ©ãƒ™ãƒ«ã®å–å¾—
----------------------------------------------------------------
local function getStatusText(hammerId, config)
	local owned = table.find(playerData.owned, hammerId) ~= nil
	local equipped = (playerData.equipped == hammerId) and (playerData.equipped ~= "NONE")
	
	if equipped then
		return "è£…å‚™æ¸ˆã¿"
	elseif owned then
		return "è£…å‚™"
	else
		-- ç‰¹æ®Šãƒãƒ³ãƒãƒ¼ï¼ˆã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å ±é…¬ãªã©ï¼‰ã‹ã¤æœªæ‰€æœ‰ã®å ´åˆ
		if config.isSpecial then
			return "LOCKED"
		end

		if config.cost >= 1000000 then
			return string.format("%.1fM", config.cost / 1000000)
		elseif config.cost >= 1000 then
			return string.format("%.1fK", config.cost / 1000)
		else
			return tostring(config.cost)
		end
	end
end

----------------------------------------------------------------
-- UIã®åˆæœŸåŒ–
local function setupUI()
	print("[HammerShop] Setting up Grid UI...")
	local playerGui = player:WaitForChild("PlayerGui")

	-- ãƒœã‚¿ãƒ³ç®¡ç†ç”¨ScreenGui
	local sidebarGui = pgui:FindFirstChild("SidebarGui")
	if not sidebarGui then
		sidebarGui = Instance.new("ScreenGui")
		sidebarGui.Name = "SidebarGui"
		sidebarGui.IgnoreGuiInset = true
		sidebarGui.ResetOnSpawn = false
		sidebarGui.Parent = pgui
	end

	-- ã‚·ãƒ§ãƒƒãƒ—ãƒœã‚¿ãƒ³ï¼ˆå·¦å´ã«é…ç½®ï¼‰
	shopButton = Instance.new("TextButton")
	shopButton.Name = "HammerShopButton"
	shopButton.Size = UDim2.new(0.12, 0, 0.045, 0)
	shopButton.Position = UDim2.new(0.02, 0, 0.26, 0)
	shopButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60)
	shopButton.Text = "ğŸ”¨ HAMMER SHOP"
	shopButton.TextColor3 = Color3.new(1, 1, 1)
	shopButton.TextScaled = true
	shopButton.Font = Enum.Font.FredokaOne
	shopButton.Parent = sidebarGui

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0.3, 0)
	corner.Parent = shopButton
	
	local stroke = Instance.new("UIStroke")
	stroke.Thickness = 2
	stroke.Color = Color3.new(0, 0, 0)
	stroke.Parent = shopButton

	-- ã‚·ãƒ§ãƒƒãƒ—ãƒ•ãƒ¬ãƒ¼ãƒ 
	local existingFrame = playerGui:FindFirstChild("HammerShop")
	if existingFrame then existingFrame:Destroy() end

	shopFrame = Instance.new("ScreenGui")
	shopFrame.Name = "HammerShop"
	shopFrame.ResetOnSpawn = false
	shopFrame.Parent = playerGui

	-- èƒŒæ™¯ (ãƒ¡ã‚¤ãƒ³)
	local bg = Instance.new("Frame")
	bg.Name = "Background"
	bg.Size = UDim2.new(0, 750, 0, 480) -- 550 -> 480
	bg.Position = UDim2.new(0.5, 0, 0.5, 0)
	bg.AnchorPoint = Vector2.new(0.5, 0.5)
	bg.BackgroundColor3 = Color3.fromRGB(160, 230, 50) -- é»„ç·‘ãƒ†ãƒ¼ãƒ
	bg.Parent = shopFrame
	
	-- å¤ªã„é»’æ ç·š
	local bgStroke = Instance.new("UIStroke", bg)
	bgStroke.Thickness = 4
	bgStroke.Color = Color3.fromRGB(0, 0, 0)
	bgStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	
	-- å†…å´ã®ç™½ã„æ ç·šï¼ˆã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰
	local innerStroke = Instance.new("UIStroke", bg)
	innerStroke.Thickness = 1.5
	innerStroke.Color = Color3.fromRGB(255, 255, 255)
	innerStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

	local uiScale = Instance.new("UIScale")
	uiScale.Parent = bg

	local aspect = Instance.new("UIAspectRatioConstraint")
	aspect.AspectRatio = 750 / 480 -- æŒ‡å®šã—ãŸèƒŒæ™¯ã‚µã‚¤ã‚ºã«åŸºã¥ã
	aspect.DominantAxis = Enum.DominantAxis.Height
	aspect.Parent = bg

	-- ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼šç”»é¢é«˜ã•ã«åˆã‚ã›ã¦è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
	local function updateUIScale()
		if not shopFrame then return end
		local screenSize = shopFrame.AbsoluteSize
		local targetHeight = 480 -- è¨­è¨ˆä¸Šã®é«˜ã•
		local targetWidth = 750  -- è¨­è¨ˆä¸Šã®å¹…

		-- ç”»é¢é«˜ã•ãŒè¶³ã‚Šãªã„å ´åˆã«ç¸®å°ã™ã‚‹
		local scaleH = math.min(1, screenSize.Y / (targetHeight + 40)) -- ä½™ç™½åˆ†ã‚’è€ƒæ…®
		local scaleW = math.min(1, screenSize.X / (targetWidth + 40))
		uiScale.Scale = math.min(scaleH, scaleW)
	end
	
	shopFrame:GetPropertyChangedSignal("AbsoluteSize"):Connect(updateUIScale)
	updateUIScale()

	local bgCorner = Instance.new("UICorner")
	bgCorner.CornerRadius = UDim.new(0, 20)
	bgCorner.Parent = bg
	
	local bgStroke = Instance.new("UIStroke")
	bgStroke.Thickness = 4
	bgStroke.Color = Color3.fromRGB(255, 255, 255)
	bgStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	bgStroke.Parent = bg

	-- ã‚¿ã‚¤ãƒˆãƒ«
	local title = Instance.new("TextLabel")
	title.Name = "Title"
	title.Size = UDim2.new(0, 300, 0, 60)
	title.Position = UDim2.new(0, 30, 0, 5)
	title.BackgroundTransparency = 1
	title.Text = "ãƒãƒ³ãƒãƒ¼"
	title.TextColor3 = Color3.new(1, 1, 1)
	title.TextSize = 36
	title.Font = Enum.Font.GothamBold
	title.TextXAlignment = Enum.TextXAlignment.Left
	title.Parent = bg
	
	local titleStroke = Instance.new("UIStroke")
	titleStroke.Thickness = 2
	titleStroke.Parent = title

	-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
	local closeButton = Instance.new("TextButton")
	closeButton.Name = "CloseButton"
	closeButton.Size = UDim2.new(0, 50, 0, 50)
	closeButton.Position = UDim2.new(1, -5, 0, -5)
	closeButton.AnchorPoint = Vector2.new(1, 0)
	closeButton.BackgroundColor3 = Color3.fromRGB(230, 50, 50)
	closeButton.Text = "X" -- âœ• -> X (æ–‡å­—åŒ–ã‘å¯¾ç­–)
	closeButton.TextColor3 = Color3.new(1, 1, 1)
	closeButton.TextSize = 30
	closeButton.Font = Enum.Font.GothamBold
	closeButton.Parent = bg

	local closeCorner = Instance.new("UICorner")
	closeCorner.CornerRadius = UDim.new(0, 12)
	closeCorner.Parent = closeButton
	
	local closeStroke = Instance.new("UIStroke")
	closeStroke.Thickness = 3
	closeStroke.Color = Color3.new(0, 0, 0)
	closeStroke.Parent = closeButton

	closeButton.Activated:Connect(function()
		shopFrame.Enabled = false
	end)

	-- å·¦ãƒ‘ãƒãƒ« (ã‚°ãƒªãƒƒãƒ‰)
	local leftPanel = Instance.new("Frame")
	leftPanel.Name = "LeftPanel"
	leftPanel.Size = UDim2.new(0.6, -40, 1, -80)
	leftPanel.Position = UDim2.new(0, 20, 0, 70)
	leftPanel.BackgroundTransparency = 1
	leftPanel.Parent = bg

	local scrollFrame = Instance.new("ScrollingFrame")
	scrollFrame.Name = "ScrollFrame"
	scrollFrame.Size = UDim2.new(1, 0, 1, 0)
	scrollFrame.BackgroundTransparency = 1
	scrollFrame.ScrollBarThickness = 6
	scrollFrame.Parent = leftPanel

	local listLayout = Instance.new("UIListLayout")
	listLayout.SortOrder = Enum.SortOrder.LayoutOrder
	listLayout.Padding = UDim.new(0, 15)
	listLayout.Parent = scrollFrame

	-- è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚µã‚¤ã‚ºèª¿æ•´
	listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
		scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 20)
	end)

	-- ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ³ãƒ†ãƒŠä½œæˆãƒ˜ãƒ«ãƒ‘ãƒ¼
	local function createSection(name, order)
		local sectionFrame = Instance.new("Frame")
		sectionFrame.Name = name .. "Section"
		sectionFrame.Size = UDim2.new(1, 0, 0, 0)
		sectionFrame.BackgroundTransparency = 1
		sectionFrame.LayoutOrder = order
		sectionFrame.Parent = scrollFrame

		local header = Instance.new("TextLabel")
		header.Name = "Header"
		header.Size = UDim2.new(1, 0, 0, 30)
		header.BackgroundTransparency = 1
		header.Text = name
		header.TextColor3 = Color3.new(1, 1, 1)
		header.TextSize = 20
		header.Font = Enum.Font.GothamBold
		header.TextXAlignment = Enum.TextXAlignment.Left
		header.Parent = sectionFrame
		
		local hStroke = Instance.new("UIStroke")
		hStroke.Thickness = 1.5
		hStroke.Parent = header

		local grid = Instance.new("UIGridLayout")
		grid.Name = "Grid"
		grid.CellSize = UDim2.new(0, 120, 0, 120)
		grid.CellPadding = UDim2.new(0, 10, 0, 10)
		grid.SortOrder = Enum.SortOrder.LayoutOrder
		grid.Parent = sectionFrame

		-- ã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ã‚’ã‚°ãƒªãƒƒãƒ‰ã«åˆã‚ã›ã‚‹
		grid:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
			sectionFrame.Size = UDim2.new(1, 0, 0, grid.AbsoluteContentSize.Y + 40)
		end)

		return sectionFrame
	end

	local standardSection = createSection("STANDARD ITEMS", 1)
	local specialSection = createSection("SPECIAL ITEMS", 2)

	-- å³ãƒ‘ãƒãƒ« (è©³ç´°)
	detailPanel = Instance.new("Frame")
	detailPanel.Name = "DetailPanel"
	detailPanel.Size = UDim2.new(0.4, -20, 1, -100)
	detailPanel.Position = UDim2.new(0.6, 0, 0, 80)
	detailPanel.BackgroundColor3 = Color3.new(1, 1, 1)
	detailPanel.Parent = bg

	local detailCorner = Instance.new("UICorner")
	detailCorner.CornerRadius = UDim.new(0, 20)
	detailCorner.Parent = detailPanel
	
	local detailStroke = Instance.new("UIStroke")
	detailStroke.Thickness = 3
	detailStroke.Parent = detailPanel

	detailName = Instance.new("TextLabel")
	detailName.Name = "ItemName"
	detailName.Size = UDim2.new(1, -20, 0, 30)
	detailName.Position = UDim2.new(0, 10, 0, 10)
	detailName.BackgroundTransparency = 1
	detailName.Text = "é¸æŠã—ã¦ãã ã•ã„"
	detailName.TextColor3 = Color3.new(0, 0, 0) -- é»’
	detailName.TextSize = 24
	detailName.Font = Enum.Font.GothamBold
	detailName.TextXAlignment = Enum.TextXAlignment.Center
	detailName.Parent = detailPanel
	
	local nameStroke = Instance.new("UIStroke")
	nameStroke.Thickness = 1.5
	nameStroke.Color = Color3.new(1, 1, 1)
	nameStroke.Parent = detailName

	detailIcon = Instance.new("ImageLabel")
	detailIcon.Name = "BigIcon"
	detailIcon.Size = UDim2.new(0, 150, 0, 150) -- 180 -> 150
	detailIcon.Position = UDim2.new(0.5, 0, 0, 45)
	detailIcon.AnchorPoint = Vector2.new(0.5, 0)
	detailIcon.BackgroundColor3 = Color3.fromRGB(255, 200, 0) -- ã‚ªãƒ¬ãƒ³ã‚¸ã£ã½ã
	detailIcon.ScaleType = Enum.ScaleType.Fit
	detailIcon.Parent = detailPanel
	
	local iconCorner = Instance.new("UICorner")
	iconCorner.CornerRadius = UDim.new(0, 30)
	iconCorner.Parent = detailIcon
	
	local iconStroke = Instance.new("UIStroke")
	iconStroke.Thickness = 3
	iconStroke.Parent = detailIcon

	-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
	detailDamage = Instance.new("TextLabel")
	detailDamage.Name = "DamageLabel"
	detailDamage.Size = UDim2.new(1, -40, 0, 30) -- 40 -> 30
	detailDamage.Position = UDim2.new(0, 20, 0, 200) -- 240 -> 200
	detailDamage.BackgroundTransparency = 1
	detailDamage.Text = "âš¡ ãƒ€ãƒ¡ãƒ¼ã‚¸: x1.0"
	detailDamage.TextColor3 = Color3.fromRGB(150, 50, 200)
	detailDamage.TextSize = 24 -- 32 -> 24
	detailDamage.Font = Enum.Font.GothamBold
	detailDamage.TextXAlignment = Enum.TextXAlignment.Left
	detailDamage.Parent = detailPanel

	detailAbility = Instance.new("TextLabel")
	detailAbility.Name = "AbilityLabel"
	detailAbility.Size = UDim2.new(1, -40, 0, 40)
	detailAbility.Position = UDim2.new(0, 20, 0, 235) -- 285 -> 235
	detailAbility.BackgroundTransparency = 1
	detailAbility.Text = "ğŸ•’ ç‰¹æ®Šèƒ½åŠ› (ã‚¢ãƒ“ãƒªãƒ†ã‚£): --"
	detailAbility.TextColor3 = Color3.fromRGB(50, 150, 255)
	detailAbility.TextSize = 18 -- 20 -> 18
	detailAbility.TextWrapped = true
	detailAbility.Font = Enum.Font.GothamBold
	detailAbility.TextXAlignment = Enum.TextXAlignment.Left
	detailAbility.TextYAlignment = Enum.TextYAlignment.Top
	detailAbility.Parent = detailPanel

	detailLimit = Instance.new("TextLabel")
	detailLimit.Name = "LimitLabel"
	detailLimit.Size = UDim2.new(1, -40, 0, 30) -- 40 -> 30
	detailLimit.Position = UDim2.new(0, 20, 0, 280) -- 330 -> 280
	detailLimit.BackgroundTransparency = 1
	detailLimit.Text = "ğŸ¯ æ½°ã›ã‚‹ç¼¶: èµ¤"
	detailLimit.TextColor3 = Color3.fromRGB(200, 50, 50)
	detailLimit.TextSize = 22 -- 32 -> 22
	detailLimit.TextWrapped = true
	detailLimit.Font = Enum.Font.GothamBold
	detailLimit.TextXAlignment = Enum.TextXAlignment.Left
	detailLimit.TextYAlignment = Enum.TextYAlignment.Top
	detailLimit.Parent = detailPanel

	-- ä¾¡æ ¼ãƒ©ãƒ™ãƒ«
	detailPriceLabel = Instance.new("TextLabel")
	detailPriceLabel.Name = "PriceLabel"
	detailPriceLabel.Size = UDim2.new(1, -40, 0, 40)
	detailPriceLabel.Position = UDim2.new(0, 20, 0, 320)
	detailPriceLabel.BackgroundTransparency = 1
	detailPriceLabel.Text = " 150K"
	detailPriceLabel.TextColor3 = Color3.fromRGB(20, 150, 20)
	detailPriceLabel.TextSize = 30
	detailPriceLabel.Font = Enum.Font.GothamBold
	detailPriceLabel.TextXAlignment = Enum.TextXAlignment.Center
	detailPriceLabel.Parent = detailPanel

	-- è³¼å…¥ãƒ»è£…å‚™ãƒœã‚¿ãƒ³
	detailActionButton = Instance.new("TextButton")
	detailActionButton.Name = "ActionButton"
	detailActionButton.Size = UDim2.new(0.9, 0, 0, 50) -- 70 -> 50
	detailActionButton.Position = UDim2.new(0.5, 0, 1, -8)
	detailActionButton.AnchorPoint = Vector2.new(0.5, 1)
	detailActionButton.BackgroundColor3 = Color3.fromRGB(0, 200, 50) -- é®®ã‚„ã‹ãªç·‘
	detailActionButton.Text = "è³¼å…¥"
	detailActionButton.TextColor3 = Color3.new(1, 1, 1)
	detailActionButton.TextSize = 28 -- 36 -> 28
	detailActionButton.Font = Enum.Font.GothamBold
	detailActionButton.Parent = detailPanel

	local btnCorner = Instance.new("UICorner")
	btnCorner.CornerRadius = UDim.new(0, 15)
	btnCorner.Parent = detailActionButton
	
	local btnStroke = Instance.new("UIStroke")
	btnStroke.Thickness = 3
	btnStroke.Parent = detailActionButton

	-- ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
	for i, hammerId in ipairs(HammerShopConfig.Order) do
		local config = HammerShopConfig.Hammers[hammerId]

		local card = Instance.new("TextButton")
		card.Name = hammerId
		card.Size = UDim2.new(0, 130, 0, 130)
		card.BackgroundColor3 = Color3.fromRGB(150, 230, 255)
		card.Text = ""
		card.LayoutOrder = i
		
		-- æŒ¯ã‚Šåˆ†ã‘
		if config.isSpecial then
			card.Parent = specialSection
		else
			card.Parent = standardSection
		end

		local cardCorner = Instance.new("UICorner")
		cardCorner.CornerRadius = UDim.new(0, 15)
		cardCorner.Parent = card
		
		local cardStroke = Instance.new("UIStroke")
		cardStroke.Thickness = 2
		cardStroke.Parent = card

		local icon = Instance.new("ImageLabel")
		icon.Name = "Icon"
		icon.Size = UDim2.new(0.8, 0, 0.8, 0)
		icon.Position = UDim2.new(0.5, 0, 0.4, 0)
		icon.AnchorPoint = Vector2.new(0.5, 0.5)
		icon.BackgroundTransparency = 1
		icon.Image = config.imageAssetId or ""
		icon.ScaleType = Enum.ScaleType.Fit
		icon.Active = false -- ã‚¯ãƒªãƒƒã‚¯ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†ã«
		icon.Parent = card

		local statusLabel = Instance.new("TextLabel")
		statusLabel.Name = "Status"
		statusLabel.Size = UDim2.new(1, 0, 0, 30)
		statusLabel.Position = UDim2.new(0, 0, 1, -5)
		statusLabel.AnchorPoint = Vector2.new(0, 1)
		statusLabel.BackgroundTransparency = 1
		statusLabel.Text = getStatusText(hammerId, config)
		statusLabel.TextColor3 = Color3.new(0, 0, 0)
		statusLabel.TextSize = 18
		statusLabel.Font = Enum.Font.GothamBold
		statusLabel.Parent = card
		
		local statusStroke = Instance.new("UIStroke")
		statusStroke.Thickness = 1.5
		statusStroke.Color = Color3.new(1, 1, 1)
		statusStroke.Parent = statusLabel

		hammerCards[hammerId] = {
			card = card,
			status = statusLabel,
			config = config
		}
		
		-- ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
		card.Activated:Connect(function()
			selectedHammerId = hammerId
			updateUI()
		end)
	end

	shopFrame.Enabled = false
	
	-- åˆæœŸé¸æŠ
	selectedHammerId = "BASIC"
end

----------------------------------------------------------------
-- UIã®å†…å®¹ã‚’æ›´æ–°
----------------------------------------------------------------
updateUI = function()
	print("[HammerShop] updateUI called for:", tostring(selectedHammerId))
	if not shopFrame then return end

	local scrapLabel = shopFrame.Background:FindFirstChild("ScrapLabel")
	if scrapLabel then
		scrapLabel.Text = "SCRAP: " .. playerData.scrap
	end

	-- ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ã®çŠ¶æ…‹ã‚’æ›´æ–°
	for hammerId, cardData in pairs(hammerCards) do
		local card = cardData.card
		local status = cardData.status
		local config = cardData.config
		
		status.Text = getStatusText(hammerId, config)
		
		-- é¸æŠä¸­ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
		if selectedHammerId == hammerId then
			card.BackgroundColor3 = Color3.fromRGB(255, 230, 100)
			card:FindFirstChildWhichIsA("UIStroke").Color = Color3.fromRGB(255, 100, 0)
			card:FindFirstChildWhichIsA("UIStroke").Thickness = 4
		else
			card.BackgroundColor3 = Color3.fromRGB(150, 230, 255)
			card:FindFirstChildWhichIsA("UIStroke").Color = Color3.new(0, 0, 0)
			card:FindFirstChildWhichIsA("UIStroke").Thickness = 2
		end
	end
	
	-- è©³ç´°ãƒ‘ãƒãƒ«ã®æ›´æ–°
	if selectedHammerId then
		local config = HammerShopConfig.Hammers[selectedHammerId]
		if not config then return end

		-- ç”»åƒã¨åå‰ã‚’æ›´æ–°
		detailIcon.Image = config.imageAssetId or ""
		detailName.Text = config.displayName or selectedHammerId
		
		-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–° (æœ€æ–°ã‚¹ãƒšãƒƒã‚¯)
		detailDamage.Text = string.format("âš¡ ãƒ€ãƒ¡ãƒ¼ã‚¸: x%.1f", config.damageMultiplier or 1.0)
		
		-- èƒ½åŠ›å (Configã‹ã‚‰å–å¾—ã€‚åŒæœŸä¸å…·åˆå¯¾ç­–ã¨ã—ã¦Controllerå´ã«ã‚‚å®šç¾©)
		local desc = config.description
		if not desc or desc == "" or desc == "ãªã—" then
			if selectedHammerId == "SHOCKWAVE" then desc = "å‘¨ã‚Šã®ç¼¶ã‚’ç ´å£Š"
			elseif selectedHammerId == "MULTI" then desc = "ãƒã‚¤ãƒ³ãƒˆå€å¢—"
			elseif selectedHammerId == "HYBRID" then desc = "å‘¨ã‚Šã®ç¼¶ã‚’ç ´å£Šï¼†ãƒã‚¤ãƒ³ãƒˆå€å¢—"
			elseif selectedHammerId == "MASTER" then desc = "å‘¨ã‚Šã®ç¼¶ã‚’ç ´å£Šï¼†ãƒã‚¤ãƒ³ãƒˆå€å¢—ï¼†å…¨ç¨®ç ´å£Š"
			else desc = "ãªã—"
			end
		end
		detailAbility.Text = "ğŸ•’ ç‰¹æ®Šèƒ½åŠ› (ã‚¢ãƒ“ãƒªãƒ†ã‚£): " .. desc

		-- ç ´å£Šåˆ¶é™
		local limitLevel = GameConfig.HammerCanLimit[selectedHammerId] or 1
		
		-- æ½°ã›ã‚‹ç¼¶ã®è‰²ãƒªã‚¹ãƒˆã‚’ä½œæˆ
		local canColors = {}
		if limitLevel >= 1 then table.insert(canColors, "èµ¤") end
		if limitLevel >= 2 then table.insert(canColors, "é’") end
		if limitLevel >= 3 then table.insert(canColors, "ç·‘") end
		if limitLevel >= 4 then table.insert(canColors, "ç´«") end
		if limitLevel >= 5 then table.insert(canColors, "é»„") end
		
		local colorList = table.concat(canColors, ", ")
		detailLimit.Text = "ğŸ¯ æ½°ã›ã‚‹ç¼¶: " .. colorList
		
		-- ãƒœã‚¿ãƒ³ã¨ä¾¡æ ¼ã®æ›´æ–°
		local owned = table.find(playerData.owned, selectedHammerId) ~= nil
		local equipped = (playerData.equipped == selectedHammerId)
		
		if equipped then
			detailActionButton.Text = "è£…å‚™æ¸ˆã¿"
			detailActionButton.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
			detailPriceLabel.Visible = false
		elseif owned then
			detailActionButton.Text = "è£…å‚™ã™ã‚‹"
			detailActionButton.BackgroundColor3 = Color3.fromRGB(230, 126, 34) -- ã‚ªãƒ¬ãƒ³ã‚¸
			detailPriceLabel.Visible = false
		else
			-- æœªæ‰€æœ‰ï¼šè³¼å…¥
			detailPriceLabel.Visible = true
			
			if config.isSpecial then
				-- ç‰¹æ®Šãƒãƒ³ãƒãƒ¼ã¯ä¾¡æ ¼è¡¨ç¤ºã§ã¯ãªãLOCKEDæ¡ˆå†…
				detailPriceLabel.Text = "COMMUNITYé™å®š"
				detailPriceLabel.TextColor3 = Color3.fromRGB(200, 50, 50) -- èµ¤
				
				detailActionButton.Text = "LOCKED"
				detailActionButton.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
			else
				-- é€šè²¨å˜ä½ã®èª¿æ•´ (Kè¡¨ç¤ºãªã©)
				local costText = tostring(config.cost)
				if config.cost >= 1000 then
					costText = string.format("%.1fK", config.cost / 1000)
				end
				detailPriceLabel.Text = string.format("ğŸ’° %s", costText)
				detailPriceLabel.TextColor3 = Color3.fromRGB(20, 150, 20) -- ç·‘
				
				if playerData.scrap >= config.cost then
					detailActionButton.Text = "è³¼å…¥"
					detailActionButton.BackgroundColor3 = Color3.fromRGB(0, 200, 50) -- ç·‘
				else
					detailActionButton.Text = "ä¸è¶³"
					detailActionButton.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
				end
			end
		end
	else
		-- é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆ
		detailName.Text = "é¸æŠã—ã¦ãã ã•ã„"
		detailIcon.Image = ""
		detailDamage.Text = "âš¡ --"
		detailAbility.Text = "ğŸ•’ --"
		detailLimit.Text = "ğŸš« --"
		detailPriceLabel.Visible = false
		detailActionButton.Text = "--"
	end
end

----------------------------------------------------------------
-- å…±é€šï¼šã‚·ãƒ§ãƒƒãƒ—ã‚’é–‹ã
----------------------------------------------------------------
local function openShop()
	if opening then return end
	opening = true

	local ok, data = pcall(function()
		return GetHammersFunc:InvokeServer()
	end)

	if ok and data then
		playerData.owned = (type(data.owned) == "table") and data.owned or {}
		playerData.equipped = data.equipped or "BASIC"
		playerData.scrap = tonumber(data.scrap) or 0
		
		-- ç¾åœ¨è£…å‚™ã—ã¦ã„ã‚‹ãƒãƒ³ãƒãƒ¼ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
		selectedHammerId = playerData.equipped
		updateUI()
	end

	if shopFrame then
		shopFrame.Enabled = true
	end

	task.delay(0.25, function()
		opening = false
	end)
end

----------------------------------------------------------------
-- ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
----------------------------------------------------------------
local function setupButtons()
	print("[HammerShop] setupButtons called, detailActionButton:", detailActionButton)
	-- è©³ç´°ãƒ‘ãƒãƒ«ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
	if detailActionButton then
		print("[HammerShop] Connecting detailActionButton.Activated event")
		detailActionButton.Activated:Connect(function()
			print("[HammerShop] Action button clicked, selectedHammerId:", selectedHammerId)
			if not selectedHammerId then return end
			
			local owned = table.find(playerData.owned, selectedHammerId) ~= nil
			local equipped = playerData.equipped == selectedHammerId
			print("[HammerShop] owned:", owned, "equipped:", equipped)

			if equipped then
				print("[HammerShop] Already equipped, returning")
				return
			elseif owned then
				print("[HammerShop] Equipping hammer:", selectedHammerId)
				local result = EquipHammerFunc:InvokeServer(selectedHammerId)
				print("[HammerShop] Equip result:", result)
				if result and result.success then
					playerData.equipped = selectedHammerId
					updateUI()
				end
			else
				-- æœªæ‰€æœ‰ã®å ´åˆ
				local config = HammerShopConfig.Hammers[selectedHammerId]
				if config and config.isSpecial then
					print("[HammerShop] Hammer is locked/special, ignoring purchase click")
					return
				end

				print("[HammerShop] Purchasing hammer:", selectedHammerId)
				local result = PurchaseHammerFunc:InvokeServer(selectedHammerId)
				if result and result.success then
					-- æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦æ›´æ–°
					local data = GetHammersFunc:InvokeServer()
					if data then
						playerData.owned = (type(data.owned) == "table") and data.owned or {}
						playerData.equipped = data.equipped or "BASIC"
						playerData.scrap = tonumber(data.scrap) or 0
					end
					updateUI()
				end
			end
		end)
	else
		warn("[HammerShop] detailActionButton is nil in setupButtons!")
	end

	-- ã‚·ãƒ§ãƒƒãƒ—ãƒœã‚¿ãƒ³ â†’ openShopã«çµ±ä¸€
	if shopButton then
		shopButton.Activated:Connect(openShop)
	end
end

----------------------------------------------------------------
-- ãƒ¯ãƒ¼ãƒ«ãƒ‰ã®ãƒˆãƒªã‚¬ãƒ¼ï¼ˆhammershopã®Trigger.ProximityPromptï¼‰
----------------------------------------------------------------
local function bindWorldTrigger()
	-- ãƒ¯ãƒ¼ãƒ«ãƒ‰ã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤ï¼ˆã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹ï¼‰
	task.wait(2)
	
	local ok, worldShop = pcall(function()
		return workspace:WaitForChild("shop", 30)  -- 30ç§’å¾…æ©Ÿ
	end)
	if not ok or not worldShop then
		warn("[HammerShop] workspace.shop not found after 30 seconds")
		return
	end

	local hammershop = worldShop:FindFirstChild("hammershop")
	if not hammershop then
		warn("[HammerShop] workspace.shop.hammershop not found")
		return
	end

	local trigger = hammershop:FindFirstChild("Trigger", true)
	if not trigger then
		warn("[HammerShop] Trigger part not found under hammershop (create Part named Trigger)")
		return
	end

	local prompt = trigger:FindFirstChildOfClass("ProximityPrompt")
	if not prompt then
		warn("[HammerShop] ProximityPrompt not found in Trigger")
		return
	end

	prompt.Triggered:Connect(function(p)
		if p ~= player then return end
		print("[HammerShop] Trigger activated by", player.Name)
		
		-- UIãŒæº–å‚™ã§ãã¦ã„ã‚‹ã‹ç¢ºèª
		if not shopFrame then
			warn("[HammerShop] ShopFrame not ready yet")
			return
		end
		
		openShop()
	end)

	print("[HammerShop] World trigger bound")
end

----------------------------------------------------------------
-- åˆæœŸåŒ–
----------------------------------------------------------------
function HammerShopController.Init()
	print("[HammerShopController] Init")

	local Constants = require(ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Config"):WaitForChild("Constants"))

	-- RemoteFunctions ã‚’å–å¾—
	PurchaseHammerFunc = Net.F(Constants.Functions.PurchaseHammer)
	EquipHammerFunc = Net.F(Constants.Functions.EquipHammer)
	GetHammersFunc = Net.F(Constants.Functions.GetPlayerHammers)

	-- UI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
	setupUI()
	setupButtons()

	-- ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒˆãƒªã‚¬ãƒ¼ç´ä»˜ã‘
	bindWorldTrigger()

	print("[HammerShopController] Ready")
end

return HammerShopController
